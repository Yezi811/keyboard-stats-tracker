# 实施计划

- [x] 1. 初始化项目结构和依赖





  - 创建 Electron + TypeScript 项目结构
  - 安装核心依赖: electron, iohook, sqlite3, chart.js, fast-check, jest
  - 配置 TypeScript 编译选项和 Jest 测试环境
  - 设置项目目录结构: src/{main, renderer, domain, infrastructure}
  - _需求: 所有需求的基础_

- [x] 2. 实现数据模型和数据库层




  - [x] 2.1 创建数据模型接口和类型定义


    - 定义 Keystroke, KeyStats, DailyStats, MonthlyStats, YearlyStats 接口
    - 创建数据库模式 SQL 脚本
    - _需求: 1.1, 1.4, 2.1_
  
  - [x] 2.2 实现 KeystrokeRepository


    - 实现 SQLite 数据库连接管理
    - 实现 save, getByDateRange, getStatsByPeriod 方法
    - 实现 clear, backup, restore 方法
    - 添加数据库索引优化
    - _需求: 2.1, 2.2, 2.3, 10.2, 10.3, 10.5_
  
  - [x] 2.3 编写属性测试: 数据持久化往返






    - **属性 2: 数据持久化往返**
    - **验证需求: 2.1, 2.3**
  
  - [x] 2.4 编写属性测试: 数据持久性保证






    - **属性 3: 数据持久性保证**
    - **验证需求: 2.2**
  
  - [x] 2.5 编写属性测试: 备份恢复往返






    - **属性 17: 备份恢复往返**
    - **验证需求: 10.5**

- [x] 3. 实现键盘监听器





  - [x] 3.1 实现 KeyboardListener 类


    - 使用 iohook 初始化全局键盘钩子
    - 实现 start, stop 方法
    - 实现按键事件捕获和事件发布
    - 添加错误处理和重试逻辑
    - _需求: 1.1, 1.3, 1.5_
  
  - [x] 3.2 实现按键码到名称的映射


    - 创建按键码映射表（字母、数字、符号、功能键、修饰键、特殊键）
    - 实现 keyCodeToName 转换函数
    - 处理未知按键的通用标识符
    - _需求: 9.1, 9.2, 9.3, 9.5_
  
  - [x] 3.3 编写属性测试: 按键捕获完整性






    - **属性 1: 按键捕获完整性**
    
    - **验证需求: 1.1, 1.4**
  
  - [x] 3.4 编写属性测试: 按键识别准确性






    - **属性 13: 按键识别准确性**
    - **验证需求: 9.1, 9.2, 9.3**
  
  - [x] 3.5 编写属性测试: 组合键独立计数






    - **属性 14: 组合键独立计数**
    - **验证需求: 9.4**

- [ ] 4. 实现内存缓冲区和批量写入







  - [x] 4.1 实现 KeystrokeBuffer 类


    - 实现 add 方法添加敲击事件到缓冲区
    - 实现 flush 方法批量写入数据库
    - 实现定时刷新机制（5 秒或 100 个事件）
    - 添加写入失败重试逻辑
    - _需求: 2.1, 2.4_
  
  - [ ] 4.2 集成 KeyboardListener 和 KeystrokeBuffer








    - 连接键盘事件到缓冲区
    - 确保应用关闭时刷新缓冲区
    - _需求: 1.1, 2.1_

- [x] 5. 实现统计服务






  - [x] 5.1 实现 StatisticsService 类



    - 实现 getDailyStats 方法
    - 实现 getMonthlyStats 方法
    - 实现 getYearlyStats 方法
    - 实现 getTopKeys 方法
    - 添加日期边界处理逻辑
    - _需求: 3.1, 3.2, 3.3, 3.5, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4_
  
  - [x] 5.2 编写属性测试: 日期范围过滤准确性






    - **属性 4: 日期范围过滤准确性**
    - **验证需求: 3.3, 4.3, 5.3**
  
  - [x] 5.3 编写属性测试: 统计聚合准确性






    - **属性 5: 统计聚合准确性**
    - **验证需求: 3.1, 3.2, 4.1, 4.2, 5.1, 5.2**
  
  - [x] 5.4 编写属性测试: 统计结果排序






    - **属性 6: 统计结果排序**
    - **验证需求: 3.5**
  
  - [x] 5.5 编写属性测试: 趋势数据一致性






    - **属性 7: 趋势数据一致性**
    - **验证需求: 4.4, 5.4**
  
  - [x] 5.6 编写单元测试: 边缘情况






    - 测试空数据返回零计数
    - 测试闰年 2 月 29 日处理
    - 测试跨年月份处理
    - _需求: 3.4, 4.5, 5.5_

- [x] 6. 检查点 - 确保核心功能测试通过









  - 确保所有测试通过，如有问题请询问用户

- [-] 7. 实现图表渲染器


  - [x] 7.1 实现 ChartRenderer 类



    - 集成 Chart.js 库
    - 实现 renderBarChart 方法（日统计）
    - 实现 renderLineChart 方法（月/年统计）
    - 配置图表样式、标签和图例
    - 实现 destroy 方法清理图表资源
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 7.2 编写属性测试: 图表类型正确性






    - **属性 8: 图表类型正确性**
    - **验证需求: 6.2, 6.3, 6.4**
  
  - [x] 7.3 编写属性测试: 图表数据完整性






    - **属性 9: 图表数据完整性**
    - **验证需求: 6.1, 6.5**

- [x] 8. 实现导出服务




  - [x] 8.1 实现 ExportService 类



    - 实现 exportToJSON 方法
    - 实现 exportToCSV 方法（包含表头）
    - 实现时间范围过滤
    - 添加文件写入错误处理
    - _需求: 7.1, 7.2, 7.3, 7.4_
  
  - [x] 8.2 编写属性测试: JSON 导出往返






    - **属性 10: JSON 导出往返**
    - **验证需求: 7.2**
  
  - [x] 8.3 编写属性测试: CSV 格式正确性






    - **属性 11: CSV 格式正确性**
    - **验证需求: 7.3**
  
  - [x] 8.4 编写属性测试: 导出范围过滤





    - **属性 12: 导出范围过滤**
    - **验证需求: 7.4**

- [x] 9. 实现用户界面




  - [x] 9.1 创建主窗口 HTML 结构


    - 创建统计周期选择器（日/月/年）
    - 创建日期选择器
    - 创建图表显示区域
    - 创建数据表格显示区域
    - 添加导出和重置按钮
    - _需求: 8.1, 8.3_
  
  - [x] 9.2 实现 UI 样式


    - 创建 CSS 样式文件
    - 实现响应式布局
    - 添加加载指示器样式
    - _需求: 8.1, 8.5_
  
  - [x] 9.3 实现 UIController 类


    - 实现 initialize 方法初始化 UI 组件
    - 实现 onPeriodChange 处理周期切换
    - 实现 onExportRequest 处理导出请求
    - 实现 onResetRequest 处理重置请求
    - 实现 updateDisplay 更新统计显示
    - 添加加载状态管理
    - _需求: 8.1, 8.2, 8.3, 8.5_

- [x] 10. 实现重置和恢复功能





  - [x] 10.1 实现数据重置功能


    - 实现确认对话框
    - 实现数据清除逻辑
    - 实现备份创建逻辑
    - _需求: 10.1, 10.2, 10.3_
  

  - [x] 10.2 实现数据恢复功能

    - 实现从备份恢复数据
    - 实现恢复后 UI 更新
    - _需求: 10.5_
  
  - [x] 10.3 编写属性测试: 数据重置完整性






    - **属性 15: 数据重置完整性**
    - **验证需求: 10.2**
  
  - [x] 10.4 编写属性测试: 备份创建保证






    - **属性 16: 备份创建保证**
    - **验证需求: 10.3**
  
  - [x] 10.5 编写属性测试: 重置后计数重启






    - **属性 18: 重置后计数重启**
    - **验证需求: 10.4**

- [x] 11. 实现错误处理和日志





  - [x] 11.1 实现 ErrorLogger 类


    - 实现 logError 和 logWarning 方法
    - 实现日志文件写入
    - 实现 getRecentErrors 方法
    - _需求: 2.4, 2.5_
  
  - [x] 11.2 集成错误处理到各组件


    - 添加键盘监听失败处理
    - 添加数据库连接失败处理
    - 添加数据写入失败处理
    - 添加图表渲染失败处理
    - 添加导出失败处理
    - 显示用户友好的错误消息
    - _需求: 2.4, 2.5_

- [x] 12. 实现 Electron 主进程




  - [x] 12.1 创建主进程入口文件


    - 实现应用窗口创建
    - 实现 IPC 通信处理
    - 实现应用生命周期管理
    - 确保应用关闭时刷新缓冲区
    - _需求: 1.5, 2.1_
  
  - [x] 12.2 配置应用权限和安全策略


    - 配置键盘监听权限
    - 配置内容安全策略
    - 禁用 Node.js 集成（使用 preload 脚本）
    - _需求: 1.3_

- [x] 13. 集成所有组件




  - [x] 13.1 连接主进程和渲染进程


    - 实现 preload 脚本暴露安全 API
    - 实现 IPC 消息处理
    - 连接键盘监听器到数据存储
    - 连接统计服务到 UI
    - _需求: 所有需求_
  
  - [x] 13.2 实现应用启动流程


    - 初始化数据库
    - 启动键盘监听
    - 加载历史数据
    - 显示主界面
    - _需求: 1.5, 2.3, 8.1_

- [x] 14. 检查点 - 端到端测试





  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 性能优化




  - [x] 15.1 实现查询缓存


    - 缓存最近的统计查询结果
    - 实现 5 分钟缓存过期
    - _需求: 3.1, 4.1, 5.1_
  
  - [x] 15.2 优化数据库查询


    - 验证索引使用
    - 优化复杂查询
    - _需求: 3.1, 4.1, 5.1_

- [x] 16. 配置应用打包




  - [x] 16.1 配置 electron-builder


    - 配置 Windows NSIS 安装程序
    - 配置 macOS DMG 镜像
    - 配置 Linux AppImage 和 Debian 包
    - 设置应用图标和元数据
    - _需求: 所有需求_
  
  - [x] 16.2 创建构建脚本


    - 创建 npm 构建脚本
    - 创建打包脚本
    - 测试各平台打包
    - _需求: 所有需求_

- [x] 17. 最终检查点





  - 确保所有测试通过，如有问题请询问用户
